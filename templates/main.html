{% extends 'base.html' %}


{% block head %}
<link rel="stylesheet" href="{{url_for('static', filename='main.css')}}">
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js" integrity="sha384-2huaZvOR9iDzHqslqwpR87isEmrfxqyWOF7hr7BY6KG0+hVKLoEXMPUJw3ynWuhO" crossorigin="anonymous"></script>
{% endblock %}


{% block body %}
<body onload="startup()">
    <div class="current-status">
        â€» Current status: Guest
    </div>

    <div class="authentication">
        
        <div class="register">
            <div style="font-size: medium; font-weight: bold;">Don't have an account?</div>
            <form action="/signup" method="post">
                <label>Username: <br><input id="register-form-username" type="text" name="register-username"/></label><br/>
                <label>Password: &nbsp; <br><input id="register-form-password" type="password" name="register-password"></label><br/>
                <label>Re-enter Password: &nbsp; <br><input id="register-form-password2" type = 'password' name = 'register-password2'></label><br/>
                <input type="submit" href='/signup' value="Create">
            </form>
        </div>

        <div class="login">
            <div style="font-size: medium; font-weight: bold;">Login</div>
                <form action="/login" method="post">
                    <label>Username: <br><input id="login-form-username" type="text" name="login_username"/></label><br>
                    <label>Password: &nbsp;<br><input id="login-form-password" type="password" name="login_password"></label><br>
                    <input type="submit" value="Log in">
                </form>
        </div>

        <div class="logout" hidden>
            <a href="/logout"><button id="logoutButton">Logout</button></a>
        </div>

    </div>
    

    <div class="container">
        <div class="epxlore-page">
            <h3 id="modifybyJS">Container</h3>
            <a href="/renderpostcreation"><button type="button">Create a Post!</button></a>
            <br><br/>
        </div>

        <div class="box1">
            <div id="subject1">Category 1</div>
            <div id="scroll-container">
                <div id="body_placeholder"></div>
            </div>
            <br><br/>
        </div>

        <div class="box2">    
            <div class="peoples-comments">
                <div id="subject1">Comments</div>
                <div id="comments"></div>
                <div id="scroll-container">
                    <div id="comment_placeholder"></div>
                </div>
                <div class="add-comment">
                    <form action="/add_comment" method="POST">
                        <input type="text" name="new_comment" id="comment">
                        <input hidden type="text" name="post_id" id="post_id" value="-1">
                        <input type="submit" id="submitcomment" value="Post">
                    </form>
                </div>
            </div>
        
            <div class="arrows">
                <div class="arr up" id="arrup" type="button" onclick="arrow_up()"><div></div></div>
                <div class="arr down" id="arrdown" type="button" onclick="arrow_down()"><div></div></div>
            </div>
            <script>
                // Need to modify this so that connection is only made when signing in

                // get the post ID and username
                postID = Number(document.getElementById("post_id")["value"]);
                username = document.getElementsByClassName("current-status")["value"];

                // make it use websockets
                const socket = io({'transports':['websocket']});
                socket.emit("getMax", {direction: 0, "postID": postID});

                /* Need to disconnect them from the room and reconnect to a new one when they:
                    increase the post, decrease the post  */

                document.getElementById("submitcomment").addEventListener("click", function() {
                    postID = Number(document.getElementById("post_id").value);
                    comment = document.getElementById("comment").value;
                    socket.emit("SendMessage", { message: comment, channel: postID });
                });

                // socket.on('connect', function() { socket.emit("connection", {user : username, socketid: socket.id}); });
                socket.on("sent", function(data){
                    message = data['message'];
                    chat.innerHTML += message["postowner"] + ": " + message["body"] + "<br>"
                })
                // document.getElementById("logoutButton").addEventListener("click", function(){ });
                // Disconnect Websocket
                
                document.getElementById("arrup").addEventListener("click", function() {
                    // Leave the current chat, enter the next
                    postID = Number(document.getElementById("post_id")["value"]);
                    socket.emit("leave", {channel: postID});
                    socket.emit("getMax", {direction: 1, "postID": postID});
                });

                document.getElementById("arrdown").addEventListener("click", function() {
                    // Leave the current chat, enter the next
                    postID = Number(document.getElementById("post_id")["value"]);
                    socket.emit("leave", {channel: postID});
                    socket.emit("getMax", {direction: -1, "postID": postID});
                });

                // This function will try to only recieve the ID of the channel to join and join it.
                socket.on("get max", function(data) {
                    
                    comments = data['comments'];
                    socket.emit("join", {channel: data['postID'], user: username});
                        
                    // clear the comment box
                    chat = document.getElementById("comment_placeholder");
                    chat.innerHTML = "";
                    
                    // display the comments
                    for (let i = 0; i < comments.length; i++) {
                        chat.innerHTML += comments[i]["postowner"] + ": " + comments[i]["body"] + "<br>";
                    }
                });

            </script>
        </div>
    </div>
</body>
{% endblock %}
